---
title: "PCAs"
author: "Marc"
date: "14/4/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Libraries

```{r include=FALSE}
rm(list=ls()) 
set.seed(1234)
library(ggplot2)
library(ggfortify)
library(plotly)
library(cowplot)
library(caret)
library(readr)
library(tidyr)
library(dplyr)
library(purrr)
library(ggrepel)
library(patchwork)
library(ggpubr)
library(readxl)
library(reshape2)
library(tibble)
theme_set(theme_minimal())

plot_pca <- function(tmp1, tmp2, color_label, ranks = 6){
  
  tmp3 <- prcomp(tmp2, center = T, scale. = T, rank. = ranks)

  pdata <- 
    tmp3$x %>% 
    as_tibble() %>% 
    bind_cols(tmp1 %>% select(all_of(color_label)) %>% mutate_all(as.factor)) %>% 
    pivot_longer(cols = seq(1, ncol(.)-length(color_label), by=2)) %>% 
    select(x_val = value, x_name = name, everything()) %>% 
    pivot_longer(cols = starts_with("PC")) %>% 
    select(x_name, y_name = name,x_val, y_val = value, everything()) %>%
    mutate(name = paste(x_name, "vs", y_name),
           name = factor(name, levels = sort(name) %>% unique())) %>% 
    filter(as.numeric(gsub("PC", "", x_name)) + 1 == as.numeric(gsub("PC", "", y_name)))
  
  pca_plot <- pdata %>% 
    ggplot(aes(x=x_val, y=y_val))+
    geom_point(aes_string(fill = color_label), shape = 21, color = "white")+
    facet_grid(~name, scales = "free")+
    labs(x = "", y = "")+
    NULL
  return(pca_plot)
}
```

# Data loading

```{r}
WD <- getwd()
if(WD!="C:/Users/mysit/Documents/Bioinformatica/Semestre_4/workflowr/data"){
  setwd("../workflowr/data")
}

A_mdf_original<-readRDS("../data/mdf_original.rds")
B_mdf_4throot<-readRDS("../data/mdf_4throot.rds")
C_mdf_pca_outliers_removed<-readRDS("../data/mdf_pca_outliers_removed.rds")
D_mdf_extreme_values_removed<-readRDS("../data/mdf_extreme_values_removed.rds")
E_mdf_qc_removed<-readRDS("../data/mdf_qc_removed.rds")
F_mdf_sumtoone<-readRDS("../data/mdf_sumtoone.rds")
G_mdf_robustnorm<-readRDS("../data/mdf_robustnorm.rds")
H_mdf_meansnorm<-readRDS("../data/mdf_meansnorm.rds")
I_mdf_combat<-readRDS("../data/mdf_combat.rds")
J_mdf_wave_0<-readRDS("../data/mdf_wave_0.rds")
K_mdf_Rcpm<-readRDS("../data/mdf_Rcpm.rds")
L_mdf_MSBox<-readRDS("../data/mdf_MSBox.rds")


wave_0<-readRDS("../data/mdf_wave_0.rds")
wave_03<-readRDS("../data/mdf_wave_03.rds")
wave_05<-readRDS("../data/mdf_wave_05.rds")
wave_07<-readRDS("../data/mdf_wave_07.rds")
wave_1<-readRDS("../data/mdf_wave_1.rds")
```

# Outliers PCAs

## Original Data

```{r fig.asp = 0.5, fig.width = 7}
raw     <-  A_mdf_original[6:(ncol(A_mdf_original))]
rowinfo <- A_mdf_original[0:5]
rowinfo <- tibble::rowid_to_column(rowinfo, "rowid")

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]

r  <- prcomp(x = tmp2, retx = T, center=T, scale. = T, rank. = 12)

bad_rows <- tibble(rowid2=apply(r$x, 2, function(x) {
  which(abs(x - median(x)) > (1.5 * quantile(x,0.95)-quantile(x,0.05))) 
  }) %>%
    unlist() %>% 
    as.vector()) %>% 
    count(rowid2)

tmp1 <- tmp1 %>%
  left_join(bad_rows) %>%
  mutate(n=ifelse(is.na(n), 0,n)) %>%
  mutate(label=ifelse(n>0, rowid, "")) %>%
  {.}

pd <- r$x %>% 
    as_tibble() %>%
    bind_cols(tmp1) %>%
    {.}

pd <- pd %>% 
  mutate(response = ifelse(n>0,"Outlier", "Not outlier")) %>%
  mutate(response = factor(response))

plotlist <- list()

for(i in 1:(ncol(r$x)/2)) {
  xvar <- names(pd)[2*i-1]
  yvar <- names(pd)[2*i]
  p1 <- ggplot(pd,aes(x=!!ensym(xvar), y=!!ensym(yvar), 
                      fill=response, label=label))+
  geom_point(shape=21, color="#FFFFFFFF", size=3) +
  scale_fill_manual(values = c("#D0D0D0", "#D04040")) +
  theme(legend.position="none") +
  NULL
  
  plotlist[[length(plotlist)+1]] <- p1
  rm(p1)
}

cowplot::plot_grid(plotlist = plotlist)
```

## 4th root

```{r fig.asp = 0.5, fig.width = 7}
raw     <-  B_mdf_4throot[6:(ncol(B_mdf_4throot))]
rowinfo <- B_mdf_4throot[0:5]
rowinfo <- tibble::rowid_to_column(rowinfo, "rowid")

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]

r  <- prcomp(x = tmp2, retx = T, center=T, scale. = T, rank. = 12)

bad_rows <- tibble(rowid2=apply(r$x, 2, function(x) {
  which(abs(x - median(x)) > (1.5 * quantile(x,0.95)-quantile(x,0.05))) 
  }) %>%
    unlist() %>% 
    as.vector()) %>% 
    count(rowid2)

tmp1 <- tmp1 %>%
  left_join(bad_rows) %>%
  mutate(n=ifelse(is.na(n), 0,n)) %>%
  mutate(label=ifelse(n>0, rowid, "")) %>%
  {.}

pd <- r$x %>% 
    as_tibble() %>%
    bind_cols(tmp1) %>%
    {.}

pd <- pd %>% 
  mutate(response = ifelse(n>0,"Outlier", "Not outlier")) %>%
  mutate(response = factor(response))

plotlist <- list()

for(i in 1:(ncol(r$x)/2)) {
  xvar <- names(pd)[2*i-1]
  yvar <- names(pd)[2*i]
  p1 <- ggplot(pd,aes(x=!!ensym(xvar), y=!!ensym(yvar), 
                      fill=response, label=label))+
  geom_point(shape=21, color="#FFFFFFFF", size=3) +
  scale_fill_manual(values = c("#D0D0D0", "#D04040")) +
  theme(legend.position="none") +
  NULL
  
  plotlist[[length(plotlist)+1]] <- p1
  rm(p1)
}

cowplot::plot_grid(plotlist = plotlist)
```

## PCA outliers removed

```{r fig.asp = 0.5, fig.width = 7}
raw     <-  C_mdf_pca_outliers_removed[6:(ncol(C_mdf_pca_outliers_removed))]
rowinfo <- C_mdf_pca_outliers_removed[0:5]
rowinfo <- tibble::rowid_to_column(rowinfo, "rowid")

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]

r  <- prcomp(x = tmp2, retx = T, center=T, scale. = T, rank. = 12)

bad_rows <- tibble(rowid2=apply(r$x, 2, function(x) {
  which(abs(x - median(x)) > (1.5 * quantile(x,0.95)-quantile(x,0.05))) 
  }) %>%
    unlist() %>% 
    as.vector()) %>% 
    count(rowid2)

tmp1 <- tmp1 %>%
  left_join(bad_rows) %>%
  mutate(n=ifelse(is.na(n), 0,n)) %>%
  mutate(label=ifelse(n>0, rowid, "")) %>%
  {.}

pd <- r$x %>% 
    as_tibble() %>%
    bind_cols(tmp1) %>%
    {.}

pd <- pd %>% 
  mutate(response = ifelse(n>0,"Outlier", "Not outlier")) %>%
  mutate(response = factor(response))

plotlist <- list()

for(i in 1:(ncol(r$x)/2)) {
  xvar <- names(pd)[2*i-1]
  yvar <- names(pd)[2*i]
  p1 <- ggplot(pd,aes(x=!!ensym(xvar), y=!!ensym(yvar), 
                      fill=response, label=label))+
  geom_point(shape=21, color="#FFFFFFFF", size=3) +
  scale_fill_manual(values = c("#D0D0D0", "#D04040")) +
  theme(legend.position="none") +
  NULL
  
  plotlist[[length(plotlist)+1]] <- p1
  rm(p1)
}

cowplot::plot_grid(plotlist = plotlist)
```

# PCAs showing the batch effect

## Original data

```{r fig.asp = 0.5, fig.width = 7}
mdf <- A_mdf_original
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
pog<-plot_pca(tmp1,tmp2,color_label = "batch") + labs(fill = "Batch") 
pog + ggtitle("Original Data") + theme(plot.title = element_text(face = "italic"))
```

## 4th Root

```{r fig.asp = 0.5, fig.width = 7}
mdf <- B_mdf_4throot
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
p4th<-plot_pca(tmp1,tmp2,color_label = "batch") + labs(fill = "Batch") 
p4th + ggtitle("4th Root transformed data") + theme(plot.title = element_text(face = "italic"))
```

## PCA outliers removed (rows)

```{r fig.asp = 0.5, fig.width = 7}
mdf <- C_mdf_pca_outliers_removed
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
poutrm<-plot_pca(tmp1,tmp2,color_label = "batch") + labs(fill = "Batch") 
poutrm + ggtitle("PCA outliers removed") + theme(plot.title = element_text(face = "italic"))
```

## Extreme values removed (columns)

```{r fig.asp = 0.5, fig.width = 7}
mdf <- D_mdf_extreme_values_removed
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
pextrm<-plot_pca(tmp1,tmp2,color_label = "batch") + labs(fill = "Batch") 
pextrm + ggtitle("Extreme values removed") + theme(plot.title = element_text(face = "italic"))
```

## Cleanup with QC samples as guide

```{r fig.asp = 0.5, fig.width = 7}
mdf <- E_mdf_qc_removed
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
pqc<-plot_pca(tmp1,tmp2,color_label = "batch") + labs(fill = "Batch") 
pqc + ggtitle("QC cleanup") + theme(plot.title = element_text(face = "italic"))
```

## Normalization Sum To One

```{r fig.asp = 0.5, fig.width = 7}
mdf <- F_mdf_sumtoone
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
psm1<-plot_pca(tmp1,tmp2,color_label = "batch") + labs(fill = "Batch") 
psm1 + ggtitle("Normalization Summing rows to One") + theme(plot.title = element_text(face = "italic"))
```

## Normalization "Robust"

```{r fig.asp = 0.5, fig.width = 7}
mdf <- G_mdf_robustnorm
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
probu<-plot_pca(tmp1,tmp2,color_label = "batch") + labs(fill = "Batch") 
probu + ggtitle("Normalization 'Robust method' using ranks") + theme(plot.title = element_text(face = "italic"))
```

## Normalization Using Means

```{r fig.asp = 0.5, fig.width = 7}
mdf <- H_mdf_meansnorm
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
pmeans<-plot_pca(tmp1,tmp2,color_label = "batch") + labs(fill = "Batch") 
pmeans + ggtitle("Normalization using mean centering") + theme(plot.title = element_text(face = "italic"))
```

## Normalization ComBat

```{r fig.asp = 0.5, fig.width = 7}
mdf <- I_mdf_combat
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
pcombat<-plot_pca(tmp1,tmp2,color_label = "batch") + labs(fill = "Batch") 
pcombat + ggtitle("Normalization using mean centering") + theme(plot.title = element_text(face = "italic"))
```

## Normalization WaveICA2.0 Cutoff of 0

```{r fig.asp = 0.5, fig.width = 7}
mdf <- J_mdf_wave_0
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
pwave0<-plot_pca(tmp1,tmp2,color_label = "batch") + labs(fill = "Batch") 
pwave0 + ggtitle("Normalization using WaveICA2.0 Cutoff of 0") + theme(plot.title = element_text(face = "italic"))
```

## Normalization (Probabilistic Quotient Normalization) using Rcpm

```{r fig.asp = 0.5, fig.width = 7}
mdf <- K_mdf_Rcpm
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
prcpm<-plot_pca(tmp1,tmp2,color_label = "batch") 
prcpm + labs(fill = "Batch") + ggtitle("PQN using Rpcm") + theme(plot.title = element_text(face = "italic"))
```

## Normalization (Probabilistic Quotient Normalization) using MSBox

```{r fig.asp = 0.5, fig.width = 7}
mdf <- L_mdf_MSBox
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
pmsbox<-plot_pca(tmp1,tmp2,color_label = "batch") 
pmsbox + labs(fill = "Batch") + ggtitle("PQN using MSBox") + theme(plot.title = element_text(face = "italic"))
```

# Whole Plot

```{r fig.asp = 0.6, fig.width = 10}
arrangement<- ggarrange(pog,p4th,poutrm, pextrm, pqc, psm1, probu, pmeans, pcombat,pwave0,prcpm, pmsbox,
                    labels = c("Original data", "4th Root", "PCA outliers removed", "Extreme values removed","Cleanup using QCs","Norm - Sum to 1","Norm - Robust","Norm - Means","Norm - ComBat","Norm - WaveICA2.0 cf0", "Norm - PQN Rcpm","Norm - PQN MSBox"  ),font.label = list(size = 8, color = "black"),ncol = 3, nrow = 4,common.legend = TRUE, legend = "bottom")

annotate_figure(arrangement, top = text_grob("PCAs showing how the batch effect changes", face = "italic", size = 15))
rm(arrangement)
```



# PCAs showing the age effect

## Original data

```{r fig.asp = 0.5, fig.width = 7}
mdf <- A_mdf_original
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
plot_pca(tmp1,tmp2,color_label = "age") + labs(fill = "Age") + ggtitle("Original Data") + theme(plot.title = element_text(face = "italic"))
```

## 4th Root

```{r fig.asp = 0.5, fig.width = 7}
mdf <- B_mdf_4throot
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
plot_pca(tmp1,tmp2,color_label = "age") + labs(fill = "Age") + ggtitle("4th Root transformed data") + theme(plot.title = element_text(face = "italic"))
```

## PCA outliers removed (rows)

```{r fig.asp = 0.5, fig.width = 7}
mdf <- C_mdf_pca_outliers_removed
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
plot_pca(tmp1,tmp2,color_label = "age") + labs(fill = "Age") + ggtitle("PCA outliers removed") + theme(plot.title = element_text(face = "italic"))
```

## Extreme values removed (columns)

```{r fig.asp = 0.5, fig.width = 7}
mdf <- D_mdf_extreme_values_removed
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
plot_pca(tmp1,tmp2,color_label = "age") + labs(fill = "Age") + ggtitle("Extreme values removed") + theme(plot.title = element_text(face = "italic"))
```

## Cleanup with QC samples as guide

```{r fig.asp = 0.5, fig.width = 7}
mdf <- E_mdf_qc_removed
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
plot_pca(tmp1,tmp2,color_label = "age") + labs(fill = "Age") + ggtitle("QC cleanup") + theme(plot.title = element_text(face = "italic"))
```

## Normalization Sum To One

```{r fig.asp = 0.5, fig.width = 7}
mdf <- F_mdf_sumtoone
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
plot_pca(tmp1,tmp2,color_label = "age") + labs(fill = "Age") + ggtitle("Normalization Summing rows to One") + theme(plot.title = element_text(face = "italic"))
```

## Normalization "Robust"

```{r fig.asp = 0.5, fig.width = 7}
mdf <- G_mdf_robustnorm
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
plot_pca(tmp1,tmp2,color_label = "age") + labs(fill = "Age") + ggtitle("Normalization 'Robust method' using ranks") + theme(plot.title = element_text(face = "italic"))
```

## Normalization Using Means

```{r fig.asp = 0.5, fig.width = 7}
mdf <- H_mdf_meansnorm
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
plot_pca(tmp1,tmp2,color_label = "age") + labs(fill = "Age") + ggtitle("Normalization using mean centering") + theme(plot.title = element_text(face = "italic"))
```

## Normalization ComBat

```{r fig.asp = 0.5, fig.width = 7}
mdf <- I_mdf_combat
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
plot_pca(tmp1,tmp2,color_label = "age") + labs(fill = "Age") + ggtitle("Normalization using mean centering") + theme(plot.title = element_text(face = "italic"))
```

## Normalization WaveICA2.0 Cutoff of 0

```{r fig.asp = 0.5, fig.width = 7}
mdf <- J_mdf_wave_0
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
plot_pca(tmp1,tmp2,color_label = "age") + labs(fill = "Age") + ggtitle("Normalization using WaveICA2.0 Cutoff of 0") + theme(plot.title = element_text(face = "italic"))
```

## Normalization (Probabilistic Quotient Normalization) using Rpcm

```{r fig.asp = 0.5, fig.width = 7}
mdf <- K_mdf_Rcpm
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
plot_pca(tmp1,tmp2,color_label = "age") + labs(fill = "Age") + ggtitle("PQN using Rpcm") + theme(plot.title = element_text(face = "italic"))
```

## Normalization (Probabilistic Quotient Normalization) using MSBox

```{r fig.asp = 0.5, fig.width = 7}
mdf <- L_mdf_MSBox
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
plot_pca(tmp1,tmp2,color_label = "age") + labs(fill = "Age") + ggtitle("PQN using MSBox") + theme(plot.title = element_text(face = "italic"))
```

# WaveICA2.0 Cutoff parameters effect on batches

```{r fig.asp = 0.6, fig.width = 10}
#Cutoff of 1
mdf <- wave_1
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
Wavecut1<-plot_pca(tmp1,tmp2,color_label = "batch")

#After WaveICA2.0 Cutoff of 0.7
mdf <- wave_07
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
Wavecut0.7<-plot_pca(tmp1,tmp2,color_label = "batch")

#After WaveICA2.0 Cutoff of 0.5
mdf <- wave_05
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
Wavecut0.5<-plot_pca(tmp1,tmp2,color_label = "batch")

#After WaveICA2.0 Cutoff of 0.3
mdf <- wave_03
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
Wavecut0.3<-plot_pca(tmp1,tmp2,color_label = "batch")

#After WaveICA2.0 Cutoff of 0
mdf <- wave_0
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
Wavecut0<-plot_pca(tmp1,tmp2,color_label = "batch")

#Plot

arrangement<- ggarrange(Wavecut1,Wavecut0.7,Wavecut0.5,Wavecut0.3,Wavecut0,
                    labels = c("1", "0.7", "0.5", "0.3","0"),font.label = list(size = 8, color = "black"),ncol = 3, nrow = 2,common.legend = TRUE, legend = "bottom")

annotate_figure(arrangement, top = text_grob("Testing WaveICA2.0's Cutoffs", face = "italic", size = 15))
rm(arrangement)
```

# Plotting the PCA loadings

Plotting the PCA loding for WaveICA2.0 at 0 cutoff and the preprocessed mdf.

After Extreme Values

```{r}
mdf <- D_mdf_extreme_values_removed
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]

tmp3 <- prcomp(tmp2, center = T, scale. = T, rank. = 2)

rotation<-tmp3$rotation %>% data.frame() %>% rownames_to_column("compound")
rotation %>% ggplot(aes(x = PC2, y = (1:nrow(rotation)))) +  # Apply nrow function
  geom_smooth(method = "gam",se=F) + 
  ggtitle("Loadings of PC2 after extreme values removed")

plot1<-rotation %>% ggplot(aes(compound,PC2))+geom_point(size = 1, alpha=1/10)+ geom_smooth(method = "gam",se=F, aes(x=(1:nrow(rotation)),y=PC2))

# Taking the high values
top100<-rotation %>% top_n(1000, PC2)
```

After WaveICA2.0 and a Cutoff of 0

```{r}
mdf <- wave_0
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]

tmp3 <- prcomp(tmp2, center = T, scale. = T, rank. = 2)

rotation<-tmp3$rotation %>% data.frame() %>% rownames_to_column("compound")
rotation %>% ggplot(aes(x = PC2, y = (1:nrow(rotation)))) +  # Apply nrow function
  geom_smooth(method = "gam",se=F) + 
  ggtitle("Loadings of PC2 after WaveICA2.0 Cutoff of 0")

plot2<-rotation %>% ggplot(aes(compound,PC2))+geom_point(size = 1, alpha=1/10)+ geom_smooth(method = "gam",se=F, aes(x=(1:nrow(rotation)),y=PC2))

# Taking the high values
top100<-rotation %>% top_n(1000, PC2)
```

Plotting both

```{r fig.asp = 0.4, fig.width = 12}
arrangement<- ggarrange(plot1,plot2,
                    labels = c("After Extreme Values", "WaveICA2.0 Cut 0", "0.3","0"),font.label = list(size = 8, color = "black"),ncol = 2, nrow = 1,common.legend = TRUE, legend = "bottom")
annotate_figure(arrangement, top = text_grob("Plotting the PC2 Loadings", face = "italic", size = 15))
```
