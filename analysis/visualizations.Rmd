---
title: "Visualizations and comparisons"
author: "Marc"
date: "18/3/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Libraries

```{r include=FALSE}
set.seed(1234)
library(ggplot2)
library(ggfortify)
library(plotly)
library(cowplot)
library(caret)
library(readr)
library(tidyr)
library(dplyr)
library(purrr)
library(ggrepel)
library(patchwork)
library(ggpubr)
library(tibble)
library(reshape2)
theme_set(theme_minimal())
```

```{r}
plot_pca <- function(tmp1, tmp2, color_label, ranks = 2){
  
  tmp3 <- prcomp(tmp2, center = T, scale. = T, rank. = ranks)

  pdata <- 
    tmp3$x %>% 
    as_tibble() %>% 
    bind_cols(tmp1 %>% select(all_of(color_label)) %>% mutate_all(as.factor)) %>% 
    pivot_longer(cols = seq(1, ncol(.)-length(color_label), by=2)) %>% 
    select(x_val = value, x_name = name, everything()) %>% 
    pivot_longer(cols = starts_with("PC")) %>% 
    select(x_name, y_name = name,x_val, y_val = value, everything()) %>%
    mutate(name = paste(x_name, "vs", y_name),
           name = factor(name, levels = sort(name) %>% unique())) %>% 
    filter(as.numeric(gsub("PC", "", x_name)) + 1 == as.numeric(gsub("PC", "", y_name)))
  
  pca_plot <- pdata %>% 
    ggplot(aes(x=x_val, y=y_val))+
    geom_point(aes_string(fill = color_label), shape = 21, color = "white")+
    facet_grid(~name, scales = "free")+
    labs(x = "", y = "")+
    NULL
  return(pca_plot)
}

```

# Data and models loading

```{r}
WD <- getwd()
if(WD!="C:/Users/mysit/Documents/Bioinformatica/Semestre_4/workflowr/data"){
  setwd("../workflowr/data")
}
load("models.RData")
H_BN_means <- readRDS("bn_means.rds")
Combat <- readRDS("../data/combat_model.rds")
load("../data/models_waveICA2.0.RData")
K_PQN_rcpm <- readRDS("pqn_rcpm.rds")
L_PQN_msbox <- readRDS("pqn_msbox.rds")
load("models_waveICA2.0.RData")
```

# Comparing the two normalization methods

```{r eval=FALSE, include=FALSE}
error %>% filter(model=="fit6"|model=="fit7") %>% ggplot(aes(x=rep,y=rmse, fill=rep)) + geom_bar(stat="identity",position=position_stack()) + 
  scale_fill_brewer(palette="Set3") + geom_text(aes(label=round(rmse,4)), position = position_stack(vjust = 0.5)) + 
  facet_wrap(~model)
```

```{r}
error %>% filter(model=="fit6"|model=="fit7") %>% ggplot(aes(x=model,y=rmse, color=model)) + geom_boxplot(outlier.colour = "red") + geom_boxplot(outlier.colour="red", outlier.shape=1,
                outlier.size=8) +
  geom_jitter(shape=16, position=position_jitter(0)) +
  scale_color_brewer(palette="Dark2")
```


# Getting the errors of BN using means
```{r}
results[8,] = data.frame(getTrainPerf(H_BN_means), Name = paste0("H_BN_means"), QC = "4th_root + PCA outlier removal + Bad features removal + Mean BN")

error1<-H_BN_means$pred %>%
  filter(alpha == H_BN_means$bestTune$alpha & lambda == H_BN_means$bestTune$lambda) %>% #subset 
  separate(Resample, c("fold", "rep"), "\\.") %>% 
  group_by(rep) %>% #group by replicate
  summarise(rmse = RMSE(obs, pred)) %>% 
  as.data.frame() %>% 
  mutate(model = "H_BN_means")

error<-rbind(error,error1)
```

# Getting the errors of WAVEICA files
```{r}
results[9,] = data.frame(getTrainPerf(waveICA2.0_realorder), Name = paste0("waveICA2_Cut1"), QC = "4th_root + PCA outlier removal + Bad features removal + WaveICA2.0")

error1<-waveICA2.0_realorder$pred %>%
  filter(alpha == waveICA2.0_realorder$bestTune$alpha & lambda == waveICA2.0_realorder$bestTune$lambda) %>% #subset 
  separate(Resample, c("fold", "rep"), "\\.") %>% 
  group_by(rep) %>% #group by replicate
  summarise(rmse = RMSE(obs, pred)) %>% 
  as.data.frame() %>% 
  mutate(model = "I_waveICA2.0_realorder")

error<-rbind(error,error1)
```


# Getting the errors of ComBat

```{r}
results[11,] = data.frame(getTrainPerf(Combat), Name = paste0("Combat"), QC = "4th_root + PCA outlier removal + Bad features removal + ComBat")

error1<-Combat$pred %>%
  filter(alpha == Combat$bestTune$alpha & lambda == Combat$bestTune$lambda) %>% #subset 
  separate(Resample, c("fold", "rep"), "\\.") %>% 
  group_by(rep) %>% #group by replicate
  summarise(rmse = RMSE(obs, pred)) %>% 
  as.data.frame() %>% 
  mutate(model = "J_ComBat")

error<-rbind(error,error1)
```

# Getting the errors of PQN from Rcpm
```{r}
results[12,] = data.frame(getTrainPerf(K_PQN_rcpm), Name = paste0("PQN_rcpm"), QC = "4th_root + PCA outlier removal + Bad features removal + ComBat")

error1<-K_PQN_rcpm$pred %>%
  filter(alpha == K_PQN_rcpm$bestTune$alpha & lambda == K_PQN_rcpm$bestTune$lambda) %>% #subset 
  separate(Resample, c("fold", "rep"), "\\.") %>% 
  group_by(rep) %>% #group by replicate
  summarise(rmse = RMSE(obs, pred)) %>% 
  as.data.frame() %>% 
  mutate(model = "K_PQN_rcpm")

error<-rbind(error,error1)
```



# Getting the errors of PQN from MSBox
```{r}
results[13,] = data.frame(getTrainPerf(L_PQN_msbox), Name = paste0("PQN_rcpm"), QC = "4th_root + PCA outlier removal + Bad features removal + ComBat")

error1<-L_PQN_msbox$pred %>%
  filter(alpha == L_PQN_msbox$bestTune$alpha & lambda == L_PQN_msbox$bestTune$lambda) %>% #subset 
  separate(Resample, c("fold", "rep"), "\\.") %>% 
  group_by(rep) %>% #group by replicate
  summarise(rmse = RMSE(obs, pred)) %>% 
  as.data.frame() %>% 
  mutate(model = "L_PQN_msbox")

error<-rbind(error,error1)
```





# Plotting
## Everything
```{r fig.asp = 0.6, fig.width = 14}
error %>% ggplot(aes(x=model,y=rmse, color=model)) + geom_boxplot(outlier.colour = "red") + geom_boxplot(outlier.colour="red", outlier.shape=1,
                outlier.size=8) +  geom_jitter(shape=16, position=position_jitter(0))
```

## The Normalizations
```{r fig.asp = 0.4, fig.width = 10}
test<-error %>% slice(c(76:325))
test %>% ggplot(aes(x=model,y=rmse, color=model)) + geom_boxplot(outlier.colour = "red") + geom_boxplot(outlier.colour="red", outlier.shape=1,
                outlier.size=8) +  geom_jitter(shape=16, position=position_jitter(0)) + 
  scale_color_brewer(palette="Set2")
```


# PCAs showing batch effect

## Loading the data files and PCA-ing
```{r}
WD <- getwd()
if(WD!="C:/Users/mysit/Documents/Bioinformatica/Semestre_4/workflowr/data"){
  setwd("../workflowr/data")
}



#After extreme values
mdf <- read_rds(file = "mdf_processed.rds")
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
extremes<-plot_pca(tmp1,tmp2,color_label = "batch")

#After Sum to 1
mdf <- read_rds(file = "mdf_sumtoone.rds")
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
sumto1<-plot_pca(tmp1,tmp2,color_label = "batch")

#After OG robust normalization
mdf <- read_rds(file = "mdf_robustnorm.rds")
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
ogRobust<-plot_pca(tmp1,tmp2,color_label = "batch")

#After BN means
mdf <- read_rds(file = "mdf_meansnorm.rds")
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
BNmeans<-plot_pca(tmp1,tmp2,color_label = "batch")


#After WaveICA2.0 Cutoff of 0
mdf <- read_rds(file = "mdf_wave0good.rds")
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
Wavecut0<-plot_pca(tmp1,tmp2,color_label = "batch")

#After WaveICA2.0 Cutoff of 1
mdf <- read_rds(file = "mdf_wave2good.rds")
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
Wavecut1<-plot_pca(tmp1,tmp2,color_label = "batch")

#After ComBat
mdf <- read_rds(file = "mdf_combat.rds")
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
ComBat<-plot_pca(tmp1,tmp2,color_label = "batch")

#After PQN with Rpcm package
mdf <- read_rds(file = "mdf_Rcpm.rds")
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
PQN_Rpcm<-plot_pca(tmp1,tmp2,color_label = "batch")

#After PQN with Rpcm package
mdf <- read_rds(file = "mdf_MSBox.rds")
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]
PQN_msBox<-plot_pca(tmp1,tmp2,color_label = "batch")
```

## Plotting the PCAs
```{r fig.asp = 0.6, fig.width = 10}
arrangement<- ggarrange(extremes, sumto1, ogRobust,BNmeans,Wavecut0,Wavecut1,ComBat,PQN_Rpcm,PQN_msBox,
                    labels = c("Extremes", "Sumto1", "ogRobust", "BNmeans","Wavecut0","Wavecut1","ComBat","pRcpm","pMSBox"),font.label = list(size = 8, color = "black"),ncol = 5, nrow = 2,common.legend = TRUE, legend = "bottom") + ggtitle("PCAs from the different BN methods")

annotate_figure(arrangement, top = text_grob("PCAs from the different BN methods", face = "italic", size = 15))
rm(arrangement)
```

## Plotting the PCAs focusing on WaveICA2.0
```{r fig.asp = 0.4, fig.width = 10}
arrangement<-ggarrange(extremes, Wavecut0,Wavecut1,
                    labels = c("Extremes","WaveICA2.0 Cutoff of 0","WaveICA2.0 Cutoff of 1"),font.label = list(size = 8, color = "black"),ncol = 3, nrow = 1,common.legend = TRUE, legend = "bottom") 

annotate_figure(arrangement, top = text_grob("PCAs comparing WaveICA2.0 Cutoff", face = "italic", size = 15))
rm(arrangement)
```


## Plotting the loadings of PC2

After Extreme Values
```{r}
mdf <- read_rds(file = "mdf_processed.rds")
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]

tmp3 <- prcomp(tmp2, center = T, scale. = T, rank. = 2)

rotation<-tmp3$rotation %>% data.frame() %>% rownames_to_column("compound")
rotation %>% ggplot(aes(x = PC2, y = (1:nrow(rotation)))) +  # Apply nrow function
  geom_smooth(method = "gam",se=F) + 
  ggtitle("Loadings of PC2 after extreme values removed")

# Taking the high values

top100<-rotation %>% top_n(1000, PC2)
```

## Making the batch PCA with only the top 1000 compounds with the highest loadings
```{r}
mdf <- read_rds(file = "mdf_processed.rds")
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw<-mdf[,top100$compound]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]

tmp3 <- prcomp(tmp2, center = T, scale. = T, rank. = 2)


rotation<-tmp3$rotation %>% data.frame() %>% rownames_to_column("compound")
rotation %>% ggplot(aes(x = PC2, y = (1:nrow(rotation)))) +  # Apply nrow function
  geom_smooth(method = "gam",se=F) + 
  ggtitle("Loadings of PC2 after extreme values removed")
```


After WaveICA at 0
```{r}
mdf <- read_rds(file = "mdf_wave0good.rds")
mdf<-mdf %>% mutate(rowid = row_number()) %>% relocate(rowid, .before = sample)
rowinfo <- mdf %>% select(rowid, sample, age, batch, type, sample_id)

rm(rowinfo)
raw     <-  mdf[7:(ncol(mdf))]
rowinfo <- mdf[0:6]

tmp1 <- rowinfo %>% filter(type %in% c("sample")) %>% mutate(rowid2 = row_number())
tmp2 <- raw[tmp1$rowid,]

tmp3 <- prcomp(tmp2, center = T, scale. = T, rank. = 2)

rotation<-tmp3$rotation
rotation %>% ggplot(aes(x = PC2, y = 1:nrow(rotation))) +  # Apply nrow function
  geom_smooth(method = "gam",se=F) + ggtitle("Loadings of PC2 after WaveICA2.0 cutoff of 0")
```

